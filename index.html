<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spin Wheel</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: #f4f4f9;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    canvas {
      border: 5px solid #333;
      border-radius: 50%;
      background: white;
    }
    .buttons {
      margin-top: 20px;
      display: flex;
      gap: 15px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      background: #4CAF50;
      color: white;
      transition: background 0.3s;
    }
    button:hover:not(:disabled) { background: #45a049; }
    button:disabled {
      background: gray;
      cursor: not-allowed;
    }
    .history { margin-top: 30px; text-align: center; }
    .history ul { list-style-type: none; padding: 0; }
    .history li {
      background: #ddd;
      margin: 5px 0;
      padding: 5px 10px;
      border-radius: 6px;
    }
    .segments-left {
      margin-top: 15px;
      font-size: 18px;
      color: #333;
    }
    .debug { margin-top: 10px; font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <h1>Click to Spin for the Parade!!</h1>
  <canvas id="wheel" width="400" height="400"></canvas>

  <div class="segments-left">
    Segments remaining: <span id="segmentCount">6</span>
  </div>

  <div class="buttons">
    <button id="spinBtn" onclick="spin()">Spin Wheel</button>
    <button id="resetBtn" onclick="resetWheel()">Reset Wheel</button>
  </div>

  <div class="history">
    <h2>Last 5 Results</h2>
    <ul id="historyList"></ul>
  </div>

  <div class="debug">
    Status: <span id="debugStatus">Ready to spin</span>
  </div>

  <script>
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");

    // Original wheel segments
    const originalSegments = [
      { text: "Arts/Crafts", color: "#FF6F61" , emoji: "🎨"},
      { text: "Food/Beverage", color: "#6B5B95", emoji: "🫕" },
      { text: "Lego/Puzzle", color: "#88B04B", emoji: "🧩" },
      { text: "Collection", color: "#F7CAC9", emoji: "🎎" },
      { text: "Book", color: "#92A8D1", emoji: "📕" },
      { text: "Floof", color: "#955251", emoji: "🐾" },
      { text: "Self-care Item", color: "#FFB347", emoji: "💅"},
      { text: "View (outdoors/window)", color: "#00CED1", emoji: "🏞️"},
      { text: "Art (not by you)", color: "#FF1493", emoji: "🖼️" },
      { text: "Seasonal", color: "#7FFF00", emoji: "🧤"},
      { text: "Book", color: "#92A8D1", emoji: "📕"},
      { text: "Decor", color: "#8A2BE2", emoji: "🛋️" },
      { text: "Mystery Item", color: "#FF4500", emoji: "🎲" },
      { text: "Instrument", color: "#1E90FF", emoji: "🎺" },
      { text: "Floof", color: "#92A8D1", emoji: "🐾" },
      { text: "Stuffy", color: "#DAA520", emoji: "🧸" },
      { text: "Collection", color: "#F7CAC9", emoji: "🧤" },
      { text: "Ta Das!", color: "#20B2AA", emoji: "🎉" },
      { text: "Collectable/Vintage", color: "#FF69B4", emoji: "🪙" },
      { text: "Plant", color: "#32CD32", emoji: "🪴" },
      { text: "Fidget", color: "#BA55D3", emoji: "⚙️" },
      { text: "Organization Gadget/Tip", color: "#00FA9A", emoji: "🗂️" },
      { text: "Prized Possession", color: "#FF6347", emoji: "💎" },
      { text: "Floof", color: "#955251", emoji: "🐾" },
      { text: "Lego/Puzzle", color: "#88B04B", emoji: "🧩" },
      { text: "Arts/Crafts", color: "#FF1493", emoji: "🎨" },
      { text: "Current Hyper Fixation", color: "#4682B4", emoji: "🌀" },
      { text: "Notebook/Agenda/Calendar", color: "#DA70D6", emoji: "📝" },
      { text: "View (outdoors/window)", color: "#00CED1", emoji: "🏞️" },
      { text: "Stuffy", color: "#DAA520" , emoji: "🧸"}
    ];

    // Load saved state or initialize
    let segments = localStorage.getItem("segments") ? JSON.parse(localStorage.getItem("segments")) : JSON.parse(JSON.stringify(originalSegments));
    let history = localStorage.getItem("history") ? JSON.parse(localStorage.getItem("history")) : [];
    let currentAngle = 0;
    let isSpinning = false;
    let animationId = null;

    // Disable spin button if wheel is empty
    if (segments.length === 0) {
      document.getElementById("spinBtn").disabled = true;
    }

    function updateDebugStatus(status) {
      document.getElementById("debugStatus").textContent = status;
    }

    function drawWheel() {
      const centerX = 200;
      const centerY = 200;
      const radius = 180;
      const textRadius = 130;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (segments.length === 0) {
        ctx.fillStyle = "#ddd";
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#666";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.fillText("All Done!", centerX, centerY);
        return;
      }

      const segmentAngle = (Math.PI * 2) / segments.length;

      segments.forEach((seg, i) => {
          const start = currentAngle + i * segmentAngle;
          const end = start + segmentAngle;
      
          // Draw segment
          ctx.fillStyle = seg.color;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, start, end);
          ctx.closePath();
          ctx.fill();
      
          ctx.strokeStyle = "#fff";
          ctx.lineWidth = 2;
          ctx.stroke();
      
          const textAngle = start + segmentAngle / 2;
      
          // Draw main text
          const textX = centerX + Math.cos(textAngle) * textRadius;
          const textY = centerY + Math.sin(textAngle) * textRadius;
      
          ctx.save();
          ctx.translate(textX, textY);
          ctx.rotate(textAngle + Math.PI / 2);
          ctx.fillStyle = "white";
          ctx.font = "16px Arial"; // main text font size
          ctx.textAlign = "center";
          ctx.fillText(seg.text, 0, 0);
          ctx.restore();
      
          // Draw emoji below the text
          const emojiRadius = 100; // closer to center
          ctx.save();
          ctx.translate(centerX + Math.cos(textAngle) * emojiRadius, centerY + Math.sin(textAngle) * emojiRadius);
          ctx.rotate(textAngle + Math.PI / 2);
          ctx.fillStyle = "white";
          ctx.font = "46px Arial"; // bigger font for emoji
          ctx.textAlign = "center";
          ctx.fillText(seg.emoji || "", 0, 0);
          ctx.restore();
      });

      // Draw pointer on the right side
      // Draw pointer on the right side, pointing toward the wheel
      ctx.fillStyle = "black";
      ctx.beginPath();
      ctx.moveTo(centerX + 180 - 10, centerY);  // tip of the arrow, slightly inside the wheel radius
      ctx.lineTo(centerX + 180 + 20, centerY - 10); // top corner of base
      ctx.lineTo(centerX + 180 + 20, centerY + 10); // bottom corner of base
      ctx.closePath();
      ctx.fill();
    }

    function getSelectedSegment() {
      if (segments.length === 0) return null;
      const normalizedAngle = (((-currentAngle) % (Math.PI*2)) + Math.PI*2) % (Math.PI*2);
      // Offset by -90 degrees (π/2 radians) because pointer is now on the right
      //const normalizedAngle = (((-currentAngle + Math.PI/2) % (Math.PI*2)) + Math.PI*2) % (Math.PI*2);

      const segmentAngle = (Math.PI*2) / segments.length;
      const index = Math.floor(normalizedAngle / segmentAngle);
      return segments[index];
    }

    function spin() {
      if (isSpinning || segments.length === 0) {
        updateDebugStatus("Cannot spin right now");
        return;
      }

      updateDebugStatus("Spinning...");
      isSpinning = true;

      const spins = 5 + Math.random() * 5;
      const finalAngle = spins * Math.PI * 2;
      const startTime = Date.now();
      const duration = 3000;
      const startAngle = currentAngle;

      function animate() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);

        currentAngle = startAngle + finalAngle * easeOut;
        drawWheel();

        if (progress < 1) {
          animationId = requestAnimationFrame(animate);
        } else {
          isSpinning = false;
          const selected = getSelectedSegment();
          if (selected) {
            updateDebugStatus("Spin complete!");

            // Add to history
            history.unshift(selected.text);
            if (history.length > 5) history.pop();
            updateHistory();

            // Remove from wheel
            const idx = segments.indexOf(selected);
            if (idx > -1) segments.splice(idx, 1);

            // Save state
            localStorage.setItem("segments", JSON.stringify(segments));
            localStorage.setItem("history", JSON.stringify(history));

            updateSegmentCount();

            setTimeout(() => {
              alert("You got: " + selected.text);
              if (segments.length === 0) {
                alert("All prizes have been chosen! 🎉");
                document.getElementById("spinBtn").disabled = true;
                updateDebugStatus("All done!");
              } else {
                updateDebugStatus("Ready to spin again");
              }
              drawWheel();
            }, 100);
          }
        }
      }

      animate();
    }

    function updateHistory() {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";
      history.forEach((item, i) => {
        const li = document.createElement("li");
        li.textContent = `${i+1}. ${item}`;
        historyList.appendChild(li);
      });
    }

    function updateSegmentCount() {
      document.getElementById("segmentCount").textContent = segments.length;
    }

    function resetWheel() {
      if (animationId) cancelAnimationFrame(animationId);

      segments = JSON.parse(JSON.stringify(originalSegments));
      history = [];
      currentAngle = 0;
      isSpinning = false;

      document.getElementById("spinBtn").disabled = false;

      // Clear saved state
      localStorage.removeItem("segments");
      localStorage.removeItem("history");

      updateHistory();
      updateSegmentCount();
      updateDebugStatus("Ready to spin");
      drawWheel();
    }

    // Initialize
    drawWheel();
    updateHistory();
    updateSegmentCount();
    updateDebugStatus("Ready to spin");
  </script>
</body>
</html>
